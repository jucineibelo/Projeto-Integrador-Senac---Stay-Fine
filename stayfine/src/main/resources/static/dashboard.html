<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Dashboard - StayFine</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">

    <!-- FLATPICKR -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/themes/dark.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/pt.js"></script>
    <link rel="stylesheet" href="css/dashboard.css">

    <style>
        :root {
            --gold: #D4AF37;
            --dark-bg: #1a1a2e;
            --dark-card: #16213e;
            --text-light: #f8f9fa;
            --text-muted: #6c757d;
        }
    </style>

</head>

<body>
<div class="container py-4">

    <a href="index.html" class="btn-back mb-3 d-inline-block">
        <i class="bi bi-arrow-left"></i> Voltar
    </a>

    <h2 class="mb-4">Dashboard de Agendamentos</h2>

    <!-- ESTATÍSTICAS -->
    <div class="row mb-4">
        <div class="col-md-3 col-sm-6 mb-3">
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="bi bi-calendar-check"></i>
                </div>
                <div class="stat-number" id="totalAgendamentos">0</div>
                <div class="stat-title">Total Agendamentos</div>
            </div>
        </div>
        <div class="col-md-3 col-sm-6 mb-3">
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="bi bi-person-check"></i>
                </div>
                <div class="stat-number" id="agendamentosHoje">0</div>
                <div class="stat-title">Agendamentos Hoje</div>
            </div>
        </div>
        <div class="col-md-3 col-sm-6 mb-3">
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="bi bi-clock-history"></i>
                </div>
                <div class="stat-number" id="agendamentosPendentes">0</div>
                <div class="stat-title">Pendentes</div>
            </div>
        </div>
        <div class="col-md-3 col-sm-6 mb-3">
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="bi bi-currency-dollar"></i>
                </div>
                <div class="stat-number" id="receitaEstimada">R$ 0</div>
                <div class="stat-title">Receita Estimada</div>
            </div>
        </div>
    </div>

    <!-- FILTROS -->
    <div class="filtro-card">
        <h5 class="mb-3">Filtros</h5>
        <div class="row">
            <div class="col-md-3 mb-3">
                <div class="filtro-label">Data Início</div>
                <div class="input-with-icon">
                    <input id="filtroDataInicio" type="text" class="form-control flatpickr-input"
                           placeholder="Selecionar data">
                    <i class="bi bi-calendar calendar-icon"></i>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="filtro-label">Data Fim</div>
                <div class="input-with-icon">
                    <input id="filtroDataFim" type="text" class="form-control flatpickr-input"
                           placeholder="Selecionar data">
                    <i class="bi bi-calendar calendar-icon"></i>
                </div>
            </div>
            <div class="col-md-2 mb-3">
                <div class="filtro-label">Profissional</div>
                <select id="filtroProfissional" class="form-select">
                    <option value="">Todos</option>
                </select>
            </div>
            <div class="col-md-2 mb-3">
                <div class="filtro-label">Status</div>
                <select id="filtroStatus" class="form-select">
                    <option value="">Todos</option>
                    <option value="agendado">Agendado</option>
                    <option value="pendente">Pendente</option>
                    <option value="concluido">Concluído</option>
                    <option value="cancelado">Cancelado</option>
                </select>
            </div>
            <div class="col-md-2 mb-3 d-flex align-items-end">
                <button id="btnAplicarFiltro" class="btn btn-gold me-2 w-50">Aplicar</button>
                <button id="btnResetFiltro" class="btn btn-reset w-50">Limpar</button>
            </div>
        </div>
    </div>

    <!-- TABELA DE AGENDAMENTOS -->
    <div class="card-dark">
        <h5 class="mb-3">Agendamentos</h5>
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                <tr>
                    <th>ID</th>
                    <th>Cliente</th>
                    <th>Profissional</th>
                    <th>Serviços/Produtos</th>
                    <th>Valor Total</th>
                    <th>Data Agendada</th>
                    <th>Status</th>
                    <th>Pagamento</th>
                    <th>Ações</th>
                </tr>
                </thead>
                <tbody id="agendamentosTable"></tbody>
            </table>
        </div>
    </div>

</div>

<!-- MODAL DETALHES -->
<div class="modal fade" id="modalDetalhes" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header border-secondary">
                <h5 class="modal-title">Detalhes do Agendamento</h5>
                <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>ID:</strong> <span id="detailId"></span></p>
                        <p><strong>Cliente:</strong> <span id="detailCliente"></span></p>
                        <p><strong>Profissional:</strong> <span id="detailProfissional"></span></p>
                        <p><strong>Pagamento:</strong> <span id="detailPagamento"></span></p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>Data Agendada:</strong> <span id="detailDataAgendada"></span></p>
                        <p><strong>Data Cadastro:</strong> <span id="detailDataCadastro"></span></p>
                        <p><strong>Status:</strong> <span id="detailStatus"></span></p>
                        <p><strong>Valor Total:</strong> <span id="detailValorTotal"></span></p>
                    </div>
                </div>
                <div class="mt-3">
                    <strong>Produtos/Serviços:</strong>
                    <ul id="detailProdutos" class="mt-2"></ul>
                </div>
            </div>
            <div class="modal-footer border-secondary">
                <button class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                <button class="btn btn-gold" onclick="alterarStatusAgendamento()">Alterar Status</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    const api = "http://localhost:8080";
    let agendamentos = [];
    let profissionais = [];
    let currentAgendamentoId = null;
    let agendamentosExibidos = []; // Armazena os agendamentos atualmente exibidos na tela

    // Mapa de preços dos produtos/serviços - ATUALIZE COM SEUS PRODUTOS REAIS
    const precosProdutos = {
        "Corte de Cabelo": 50.00,
        "Coloração": 120.00,
        "Manicure": 30.00,
        "Pedicure": 35.00,
        "Hidratação": 80.00,
        "Progressiva": 150.00,
        "Escova": 40.00,
        "Luzes": 180.00,
        "Tratamento Capilar": 90.00,
        "Maquiagem": 60.00
    };

    // Função para normalizar nomes (remove acentos, espaços extras, deixa minúsculo)
    function normalizarNome(nome) {
        if (!nome) return '';
        return nome
            .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
            .toLowerCase().trim();
    }

    // Cria um mapa de preços com nomes normalizados
    function getPrecosNormalizados() {
        const precosNormalizados = {};
        Object.keys(precosProdutos).forEach(k => {
            precosNormalizados[normalizarNome(k)] = precosProdutos[k];
        });
        return precosNormalizados;
    }

    // Função para calcular o valor total de UM agendamento
    function calcularValorAgendamento(agendamento) {
        const precosNormalizados = getPrecosNormalizados();
        let total = 0;

        if (agendamento.produtos && Array.isArray(agendamento.produtos)) {
            agendamento.produtos.forEach(nomeProduto => {
                const nomeNormalizado = normalizarNome(nomeProduto);
                total += precosNormalizados[nomeNormalizado] || 0;
            });
        }
        return total;
    }

    // Função para calcular a receita total de UMA LISTA de agendamentos
    function calcularReceitaTotal(listaAgendamentos) {
        return listaAgendamentos.reduce((total, agendamento) => {
            return total + calcularValorAgendamento(agendamento);
        }, 0);
    }

    // Função para formatar valor em Real
    function formatarValor(valor) {
        return valor.toLocaleString('pt-BR', {
            style: 'currency',
            currency: 'BRL',
            minimumFractionDigits: 2
        });
    }

    /* ===========================================================
       CARREGAR DADOS INICIAIS
    =========================================================== */
    async function carregarDadosIniciais() {
        try {
            const [agendamentosRes, profissionaisRes] = await Promise.all([
                fetch(api + "/agendamentos").then(r => r.json()),
                fetch(api + "/profissionais").then(r => r.json())
            ]);

            agendamentos = agendamentosRes;
            profissionais = profissionaisRes;
            agendamentosExibidos = [...agendamentos]; // Inicialmente exibe todos

            // Carregar filtro de profissionais
            const filtroProfSelect = document.getElementById('filtroProfissional');
            filtroProfSelect.innerHTML = '<option value="">Todos</option>' +
                profissionais.map(p => `<option value="${p.id}">${p.nome}</option>`).join('');

            atualizarEstatisticas();
            renderizarAgendamentos(agendamentosExibidos);
        } catch (error) {
            console.error('Erro ao carregar dados:', error);
            alert('Erro ao carregar dados do dashboard');
        }
    }

    /* ===========================================================
       ATUALIZAR ESTATÍSTICAS
    =========================================================== */
    function atualizarEstatisticas() {
        const hoje = new Date();
        const hojeStr = hoje.getFullYear() + '-' +
            String(hoje.getMonth() + 1).padStart(2, '0') + '-' +
            String(hoje.getDate()).padStart(2, '0');

        // Total de agendamentos EXIBIDOS
        document.getElementById('totalAgendamentos').textContent = agendamentosExibidos.length;

        // Agendamentos hoje (dos EXIBIDOS)
        const agendamentosHoje = agendamentosExibidos.filter(a => {
            if (!a.dataAgendamento) return false;
            const dataAgendamentoStr = a.dataAgendamento.split('T')[0];
            return dataAgendamentoStr === hojeStr;
        }).length;
        document.getElementById('agendamentosHoje').textContent = agendamentosHoje;

        // Agendamentos pendentes (dos EXIBIDOS)
        const agendamentosPendentes = agendamentosExibidos.filter(a =>
            a.status === 'pendente' || a.status === 'agendado' || !a.status
        ).length;
        document.getElementById('agendamentosPendentes').textContent = agendamentosPendentes;

        // Receita estimada (APENAS dos agendamentos EXIBIDOS)
        const receitaEstimada = agendamentosExibidos.reduce((total, a) => total + (Number(a.valorTotal) || 0), 0);
        document.getElementById('receitaEstimada').textContent = formatarValor(receitaEstimada);
    }

    /* ===========================================================
       RENDERIZAR AGENDAMENTOS NA TABELA
    =========================================================== */
    function renderizarAgendamentos(listaAgendamentos) {
        const tbody = document.getElementById('agendamentosTable');

        // Atualiza a lista de agendamentos exibidos
        agendamentosExibidos = listaAgendamentos;

        if (listaAgendamentos.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="9" class="text-center py-4">
                        <i class="bi bi-calendar-x" style="font-size: 2rem; color: var(--gold);"></i>
                        <p class="mt-2">Nenhum agendamento encontrado</p>
                    </td>
                </tr>
            `;
            return;
        }

        tbody.innerHTML = listaAgendamentos.map(a => {
            // Determinar status
            let status = a.status || 'agendado';
            let statusClass = 'badge-agendado';
            let statusText = 'Agendado';

            if (status === 'concluido') {
                statusClass = 'badge-concluido';
                statusText = 'Concluído';
            } else if (status === 'cancelado') {
                statusClass = 'badge-cancelado';
                statusText = 'Cancelado';
            } else if (status === 'pendente') {
                statusClass = 'badge-pendente';
                statusText = 'Pendente';
            }

            // Calcular valor total deste agendamento
            const valorTotal = Number(a.valorTotal) || 0;

            // Formatar data
            const dataFormatada = a.dataAgendamento ?
                new Date(a.dataAgendamento).toLocaleString('pt-BR', {
                    dateStyle: 'short',
                    timeStyle: 'short'
                }) : '-';

            // Limitar produtos exibidos
            const produtosExibicao = (a.produtos || []).slice(0, 2).join(', ');
            const produtosMais = (a.produtos || []).length > 2 ? ` +${(a.produtos || []).length - 2}` : '';

            return `
                <tr>
                    <td>${a.id}</td>
                    <td>${a.cliente || '-'}</td>
                    <td>${a.profissional || '-'}</td>
                    <td>${produtosExibicao}${produtosMais}</td>
                    <td class="valor-total">${formatarValor(valorTotal)}</td>
                    <td>${dataFormatada}</td>
                    <td><span class="badge-status ${statusClass}">${statusText}</span></td>
                    <td>${a.pagamento || '-'}</td>
                    <td>
                        <i class="bi bi-eye icon-action" onclick="verDetalhes(${a.id})"></i>
                        <i class="bi bi-pencil-square icon-action" onclick="editarAgendamento(${a.id})"></i>
                        <i class="bi bi-trash3 icon-action" onclick="excluirAgendamento(${a.id})"></i>
                    </td>
                </tr>
            `;
        }).join('');

        // Atualiza as estatísticas após renderizar
        atualizarEstatisticas();
    }

    /* ===========================================================
       APLICAR FILTROS
    =========================================================== */
    function aplicarFiltros() {
        const dataInicio = document.getElementById('filtroDataInicio').value;
        const dataFim = document.getElementById('filtroDataFim').value;
        const profissionalId = document.getElementById('filtroProfissional').value;
        const status = document.getElementById('filtroStatus').value;

        let filtrados = [...agendamentos];

        // Converte dd/mm/yyyy para yyyy-mm-dd
        function parseDataBR(dataStr) {
            if (!dataStr) return null;
            const [dia, mes, ano] = dataStr.split('/');
            return `${ano}-${mes.padStart(2, '0')}-${dia.padStart(2, '0')}`;
        }

        // Filtrar por data
        if (dataInicio) {
            const inicio = parseDataBR(dataInicio);
            filtrados = filtrados.filter(a => {
                const dataAgendamento = a.dataAgendamento ? a.dataAgendamento.split('T')[0] : null;
                return dataAgendamento && dataAgendamento >= inicio;
            });
        }

        if (dataFim) {
            const fim = parseDataBR(dataFim);
            filtrados = filtrados.filter(a => {
                const dataAgendamento = a.dataAgendamento ? a.dataAgendamento.split('T')[0] : null;
                return dataAgendamento && dataAgendamento <= fim;
            });
        }

        // Filtrar por profissional
        if (profissionalId) {
            const nomeProfissional = (profissionais.find(p => p.id == profissionalId)?.nome || '').trim().toLowerCase();
            filtrados = filtrados.filter(a =>
                (a.profissional || '').trim().toLowerCase() === nomeProfissional
            );
        }

        // Filtrar por status
        if (status) {
            filtrados = filtrados.filter(a => (a.status || 'agendado') === status);
        }

        // Renderizar apenas os filtrados
        renderizarAgendamentos(filtrados);
    }

    /* ===========================================================
       VER DETALHES DO AGENDAMENTO
    =========================================================== */
    async function verDetalhes(id) {
        const agendamento = agendamentos.find(a => a.id == id);
        if (!agendamento) return;

        currentAgendamentoId = id;

        // Calcular valor total deste agendamento
        const valorTotal = calcularValorAgendamento(agendamento);

        // Preencher modal de detalhes
        document.getElementById('detailId').textContent = agendamento.id;
        document.getElementById('detailCliente').textContent = agendamento.cliente || '-';
        document.getElementById('detailProfissional').textContent = agendamento.profissional || '-';
        document.getElementById('detailPagamento').textContent = agendamento.pagamento || '-';
        document.getElementById('detailValorTotal').textContent = formatarValor(valorTotal);

        const dataAgendada = agendamento.dataAgendamento ?
            new Date(agendamento.dataAgendamento).toLocaleString('pt-BR') : '-';
        document.getElementById('detailDataAgendada').textContent = dataAgendada;

        const dataCadastro = agendamento.dataCadastro ?
            new Date(agendamento.dataCadastro).toLocaleString('pt-BR') : '-';
        document.getElementById('detailDataCadastro').textContent = dataCadastro;

        // Status
        let status = agendamento.status || 'agendado';
        let statusText = 'Agendado';
        if (status === 'concluido') statusText = 'Concluído';
        else if (status === 'cancelado') statusText = 'Cancelado';
        else if (status === 'pendente') statusText = 'Pendente';

        document.getElementById('detailStatus').textContent = statusText;

        // Produtos
        const produtosList = document.getElementById('detailProdutos');
        produtosList.innerHTML = '';

        if (agendamento.produtos && agendamento.produtos.length > 0) {
            const precosNormalizados = getPrecosNormalizados();

            agendamento.produtos.forEach(produto => {
                const li = document.createElement('li');
                const nomeNormalizado = normalizarNome(produto);
                const preco = precosNormalizados[nomeNormalizado] || 0;
                li.textContent = `${produto} - ${formatarValor(preco)}`;
                produtosList.appendChild(li);
            });
        } else {
            produtosList.innerHTML = '<li>Nenhum produto/serviço cadastrado</li>';
        }

        // Mostrar modal
        const modal = new bootstrap.Modal(document.getElementById('modalDetalhes'));
        modal.show();
    }

    /* ===========================================================
       EDITAR AGENDAMENTO
    =========================================================== */
    function editarAgendamento(id) {
        window.location.href = `agendamentos.html?edit=${id}`;
    }

    /* ===========================================================
       EXCLUIR AGENDAMENTO
    =========================================================== */
    async function excluirAgendamento(id) {
        if (!confirm('Tem certeza que deseja excluir este agendamento?')) return;

        try {
            const response = await fetch(`${api}/agendamentos/${id}`, {
                method: 'DELETE'
            });

            if (response.ok) {
                // Remover da lista local
                agendamentos = agendamentos.filter(a => a.id != id);
                agendamentosExibidos = agendamentosExibidos.filter(a => a.id != id);

                // Atualizar display
                renderizarAgendamentos(agendamentosExibidos);

                alert('Agendamento excluído com sucesso!');
            } else {
                alert('Erro ao excluir agendamento');
            }
        } catch (error) {
            console.error('Erro ao excluir:', error);
            alert('Erro ao excluir agendamento');
        }
    }

    /* ===========================================================
       ALTERAR STATUS DO AGENDAMENTO
    =========================================================== */
    async function alterarStatusAgendamento() {
        if (!currentAgendamentoId) return;

        const novoStatus = prompt('Alterar status para:\n1. Agendado\n2. Pendente\n3. Concluído\n4. Cancelado\n\nDigite o número correspondente:');

        let statusMap = {
            '1': 'agendado',
            '2': 'pendente',
            '3': 'concluido',
            '4': 'cancelado'
        };

        const novoStatusValor = statusMap[novoStatus];
        if (!novoStatusValor) {
            alert('Opção inválida');
            return;
        }

        try {
            const response = await fetch(`${api}/agendamentos/${currentAgendamentoId}/status`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ status: novoStatusValor })
            });

            if (response.ok) {
                // Atualizar localmente
                const index = agendamentos.findIndex(a => a.id == currentAgendamentoId);
                const indexExibido = agendamentosExibidos.findIndex(a => a.id == currentAgendamentoId);

                if (index !== -1) {
                    agendamentos[index].status = novoStatusValor;
                }
                if (indexExibido !== -1) {
                    agendamentosExibidos[indexExibido].status = novoStatusValor;
                }

                // Atualizar display
                renderizarAgendamentos(agendamentosExibidos);

                // Fechar modal
                bootstrap.Modal.getInstance(document.getElementById('modalDetalhes')).hide();

                alert('Status atualizado com sucesso!');
            } else {
                alert('Erro ao atualizar status');
            }
        } catch (error) {
            console.error('Erro ao atualizar status:', error);
            alert('Erro ao atualizar status');
        }
    }

    /* ===========================================================
       INICIALIZAR FLATPICKR
    =========================================================== */
    function inicializarFlatpickr() {
        flatpickr("#filtroDataInicio", {
            dateFormat: "d/m/Y",
            locale: "pt",
            altInput: true,
            altFormat: "d/m/Y",
            allowInput: true
        });

        flatpickr("#filtroDataFim", {
            dateFormat: "d/m/Y",
            locale: "pt",
            altInput: true,
            altFormat: "d/m/Y",
            allowInput: true
        });
    }

    /* ===========================================================
       EVENT LISTENERS
    =========================================================== */
    document.addEventListener('DOMContentLoaded', function() {
        // Carregar dados
        carregarDadosIniciais();

        // Inicializar flatpickr
        inicializarFlatpickr();

        // Botão aplicar filtro
        document.getElementById('btnAplicarFiltro').addEventListener('click', aplicarFiltros);

        // Botão reset filtro
        document.getElementById('btnResetFiltro').addEventListener('click', function() {
            document.getElementById('filtroDataInicio').value = '';
            document.getElementById('filtroDataFim').value = '';
            document.getElementById('filtroProfissional').value = '';
            document.getElementById('filtroStatus').value = '';

            // Restaurar exibição de todos os agendamentos
            renderizarAgendamentos(agendamentos);
        });

        // Permitir pressionar Enter nos filtros
        document.querySelectorAll('#filtroDataInicio, #filtroDataFim, #filtroProfissional, #filtroStatus').forEach(el => {
            el.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    aplicarFiltros();
                }
            });
        });
    });

    /* ===========================================================
       ATUALIZAR PERIÓDICAMENTE (OPCIONAL)
    =========================================================== */
    setInterval(() => {
        fetch(api + "/agendamentos")
            .then(r => r.json())
            .then(data => {
                if (data.length !== agendamentos.length) {
                    agendamentos = data;
                    // Manter os filtros aplicados
                    aplicarFiltros();
                }
            })
            .catch(err => console.error('Erro ao atualizar dados:', err));
    }, 30000);
</script>

</body>
</html>